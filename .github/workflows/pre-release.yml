name: Pre-Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      move-tags:
        default: false
        description: Allow tags to be moved? Requires GitHub Release.
        required: false
        type: boolean
      publish-documentation:
        default: false
        description: Update the documentation website?
        required: false
        type: boolean
      publish-github-release:
        default: false
        description: Create a GitHub release?
        required: false
        type: boolean
      publish-npm:
        default: false
        description: Publish npm package?
        type: boolean
        required: false
      publish-oci:
        default: false
        description: Publish container?
        type: boolean
        required: false
      release-tag:
        default: dev
        description: Floating pre-release tag to use.
        type: string
        required: true

concurrency:
  group: pre-release
  cancel-in-progress: false

env:
  # renovate: datasource=node-version depName=node versioning=node
  NODE_VERSION: "24.12.0"

jobs:
  params:
    name: Determine configuration
    outputs:
      move-tags: ${{ github.event_name == 'workflow_dispatch' && inputs.move-tags || 'false' }}
      publish-documentation: ${{ github.event_name == 'workflow_dispatch' && inputs.publish-documentation || 'false' }}
      publish-github-release: ${{ github.event_name == 'workflow_dispatch' && inputs.publish-github-release || 'false' }}
      publish-npm: ${{ github.event_name == 'workflow_dispatch' && inputs.publish-npm || 'false' }}
      publish-oci: ${{ github.event_name == 'workflow_dispatch' && inputs.publish-oci || 'false' }}
      release-tag: ${{ github.event_name == 'workflow_dispatch' && inputs.release-tag || 'dev' }}
      release-channel: dev
    permissions:
      contents: none
    runs-on: ubuntu-24.04
    steps:
      - if: false
        name: Noop
        run: exit 0

  changelog:
    name: Changelog
    needs:
      - params
    outputs:
      version: ${{ steps.changelog.outputs.version-dev-extended }}
    permissions:
      contents: read
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          persist-credentials: false
          sparse-checkout: package.json
          sparse-checkout-cone-mode: false

      - id: version
        name: Extract current version
        run: echo "root-version=$(jq --raw-output '.version' package.json)" >> $GITHUB_OUTPUT

      - id: changelog
        name: Generate changelog
        uses: oliversalzburg/action-automatic-semantic-releases@85df1a5f81e6a18f5bb88eb495198b27399066dc # v2.0.0
        with:
          automatic-release-tag: ${{ needs.params.outputs.release-tag }}
          changelog-artifact: changelog.json
          dry-run: true
          publish: false
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          root-version: ${{ steps.version.outputs.root-version }}

      - name: Store changelog
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: changelog.json
          path: changelog.json

  qa:
    name: ðŸ”¹ QA
    uses: ./.github/workflows/qa.yml

  publish-devcontainer:
    if: success() && needs.params.outputs.publish-oci == 'true'
    name: ðŸ”¹ Publish
    needs:
      - changelog
      - params
      - qa
    permissions:
      attestations: write
      contents: read
      id-token: write
      packages: write
      pages: write
      pull-requests: read
      security-events: write
    uses: oliversalzburg/workflows/.github/workflows/publish-oci.yml@main
    with:
      artifact-name: devcontainer-output
      containerfile: devcontainer/Containerfile
      dist-tag: ${{ needs.params.outputs.release-tag }}
      image-description: Kitten Science Development Container
      image-name: kitten-science/devcontainer
      image-tag: v${{ needs.changelog.outputs.version }}
      image-title: devcontainer
      push: ${{ needs.params.outputs.move-tags == 'true' }}
      with-sarif: false
      with-sbom: false

  publish-documentation:
    if: success() && needs.params.outputs.publish-documentation == 'true'
    name: ðŸ”¹ Publish
    needs:
      - params
      - qa
    permissions:
      contents: read
      id-token: write
    uses: ./.github/workflows/publish-documentation.yml
    with:
      publish-url: https://next.kitten-science.com

  publish-npm:
    if: success() && needs.params.outputs.publish-npm == 'true'
    name: ðŸ”¹ Publish
    needs:
      - changelog
      - params
      - qa
    permissions:
      contents: write
      id-token: write
      packages: write
      pages: write
      pull-requests: read
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
    uses: oliversalzburg/workflows/.github/workflows/frag-publish-npm.yml@main
    with:
      dist-tag: ${{ needs.params.outputs.release-tag }}
      version: ${{ needs.changelog.outputs.version }}

  pre-release:
    if: |
      always()
      && contains(needs.*.result, 'success')
      && !contains(needs.*.result, 'failure')
      && needs.params.outputs.publish-github-release == 'true'
    name: Pre-Release
    needs:
      - changelog
      - params
      - publish-devcontainer
      - publish-documentation
      - publish-npm
      - qa
    permissions:
      actions: write
      attestations: write
      contents: write
      id-token: write
      packages: write
      pull-requests: read
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          persist-credentials: false

      - name: Select Node.js version
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: https://registry.npmjs.org

      - name: Load cached dependencies
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node{{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-node${{ env.NODE_VERSION }}

      - name: Build release
        env:
          RELEASE_CHANNEL: ${{ needs.params.outputs.release-channel }}
          RELEASE_VERSION: ${{ needs.changelog.outputs.version }}
        run: make

      - name: Download changelog
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: changelog.json

      - if: success() && needs.params.outputs.publish-github-release == 'true'
        name: Generate GitHub release
        uses: oliversalzburg/action-automatic-semantic-releases@85df1a5f81e6a18f5bb88eb495198b27399066dc # v2.0.0
        with:
          automatic-release-tag: ${{ needs.params.outputs.release-tag }}
          body-suffix: |

            ---
            - Release generated by <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}>
            ${{ needs.publish-documentation.outputs.publish-url && format('- Documentation published at <{0}>', needs.publish-documentation.outputs.publish-url) }}
            ${{ needs.publish-devcontainer.outputs.publish-url && format('- Devcontainer published at <{0}>', needs.publish-devcontainer.outputs.publish-url) }}
            ${{ needs.publish-npm.outputs.publish-url && format('- npm package published at <{0}>', needs.publish-npm.outputs.publish-url) }}
          changelog-artifact: changelog.json
          # If we only _draft_ the release, the release-info action (which runs later)
          # will not find any artifacts to put in the update metadata, because the release is still a draft.
          draft: false
          dry-run: ${{ needs.params.outputs.move-tags == 'false' }}
          files: output/*.js
          merge-similar: true
          prerelease: true
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          title: Development Build v${{ needs.changelog.outputs.version }}
          with-authors: false

  update-release-info:
    # The Release Info action uses GitHub releases as source of truth.
    # If we didn't publish a release, there is no need to update the information.
    if: success() && needs.params.outputs.publish-github-release == 'true'
    name: ðŸ”¹ Publish
    needs:
      - params
      - pre-release
    permissions:
      contents: read
      id-token: write
    uses: ./.github/workflows/publish-release-info.yml
